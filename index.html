<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>mn.vote</title>
    
    <!-- Placeholder for sa_event to queue events before the script loads -->
    <script>
        window.sa_event = window.sa_event || function() {
            var a = [].slice.call(arguments);
            window.sa_event.q ? window.sa_event.q.push(a) : window.sa_event.q = [a];
        };
    </script>

    <!-- Google Analytics tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SYF2WH4DFV"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-SYF2WH4DFV');

        // Capture URL parameters for GA4
        const urlParamsGA = new URLSearchParams(window.location.search);
        const mGA = urlParamsGA.get('m');
        const vGA = urlParamsGA.get('v');
        const tGA = urlParamsGA.get('t');
        const whoGA = urlParamsGA.get('who');
        
        // Send a custom event to GA4 with the parameters
        gtag('event', 'custom_page_view', {
            'm': mGA,
            'v': vGA,
            't': tGA,
            'who': whoGA
        });
    </script>
</head>
<body>
    <p>testing.</p>
    
    <!-- Simple Analytics script for privacy-first analytics (placed in body) -->
    <script 
        data-allow-params="t,m,v,who"
        data-collect-dnt="false"
        async defer src="https://scripts.simpleanalyticscdn.com/latest.js">
    </script>
    <noscript>
        <img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" />
    </noscript>

    <!-- Custom Event Tracking Script -->
    <script>
        (function() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const m = urlParams.get('m');
            const t = urlParams.get('t');

            // Function to send events to SimpleAnalytics
            function sendSimpleAnalyticsEvent(eventName) {
                if (typeof sa_event === 'function') {
                    sa_event(eventName);
                }
            }

            // Array of valid m and t values
            const validM = ['1', '2', '3', '4', '5', '6', '99'];
            const validT = ['1', '3', '6', '9'];

            // Track m parameters
            if (m && validM.includes(m)) {
                sendSimpleAnalyticsEvent(`mailer${m}_view`);
            }

            // Track t parameters
            if (t && validT.includes(t)) {
                sendSimpleAnalyticsEvent(`treatment${t}_view`);
            }

            // Function to handle redirect after events are sent
            function redirect() {
                window.location.href = "https://www.sos.mn.gov/elections-voting/";
            }

            // Function to send events and then redirect
            function sendEventsAndRedirect() {
                let eventsSent = false;

                // Send m events
                if (m && validM.includes(m)) {
                    sendSimpleAnalyticsEvent(`mailer${m}_view`);
                }

                // Send t events
                if (t && validT.includes(t)) {
                    sendSimpleAnalyticsEvent(`treatment${t}_view`);
                }

                // Use a callback to ensure events are sent before redirecting
                // SimpleAnalytics does not support callbacks directly, so we use a timeout
                // Adjust the timeout duration if needed
                setTimeout(redirect, 3000); // 3-second delay
            }

            // Initiate event tracking and redirect
            sendEventsAndRedirect();
        })();
    </script>
</body>
</html>
